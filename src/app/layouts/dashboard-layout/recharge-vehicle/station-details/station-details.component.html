<section class="bg-gray-50 px-2 md:p-6">
  <div class="border-bleu-electrique mx-auto mt-30 max-w-6xl rounded-lg border border-dashed bg-white p-6 shadow-xl">
    
    <!-- TITRE PRINCIPAL -->
    <h1 class="py-5 text-center text-xl font-bold text-blue-800">
      Demande de r√©servation
    </h1>

    <!-- INFORMATIONS DE LA BORNE -->
    <div *ngIf="chargingStation">
      <div class="mb-6 flex items-center gap-4">
        <!-- Image de la borne -->
        <img
          [src]="chargingStation.picture.src"
          [alt]="chargingStation.picture.alt"
          class="h-20 w-20 object-cover"
        />

        <div>
          <h2 class="font-semibold text-gray-800">
            {{ chargingStation.nameStation }}
          </h2>

          <!-- Adresse -->
          <p class="text-sm text-gray-600">
            {{ chargingStation.locationStation.address }},
            {{ chargingStation.locationStation.postaleCode }}
            {{ chargingStation.locationStation.city }}
          </p>

          <!-- Prix & puissance -->
          <p class="text-bleu-electrique text-sm font-semibold">
            {{ chargingStation.power }} kW - {{ chargingStation.pricePerHour }}‚Ç¨/h
          </p>

          <!-- Cr√©neaux disponibles affich√©s -->
          <span class="mt-1 inline-block rounded bg-green-600 px-3 py-1 text-xs text-white">
            Disponible de
            {{ chargingStation.timeslots[0].startTime.slice(0, 5) }} √†
            {{ chargingStation.timeslots[0].endTime.slice(0, 5) }}
          </span>
        </div>
      </div>
    </div>

    <!-- GRID 2 COLONNES : Cr√©neaux (gauche) + D√©tails & Paiement (droite) -->
    <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
      
      <!-- üü© LISTE DES CR√âNEAUX HORAIRES -->
      <div class="rounded-lg border p-4">
        <h3 class="mb-2 text-center text-lg font-bold">Cr√©neaux horaires</h3>

        <ul *ngIf="!noSlotsAvailable" class="space-y-2">
          <li
            *ngFor="let slot of slots"
            class="flex items-center justify-between rounded border px-3 py-2"
            [ngClass]="{
              'cursor-pointer border-green-500 bg-green-50 hover:bg-green-100': slot.status === 'Disponible',
              'cursor-not-allowed border-gray-300 bg-gray-100 text-gray-400': slot.status === 'Indisponible',
              'bg-blue-200 text-blue-800 ring-2 ring-blue-500': isSlotSelected(slot.time)
            }"
            (click)="toggleTime(slot.time)"
          >
            <span>{{ slot.time }}</span>
            <span [ngClass]="slot.status === 'Disponible' ? 'font-medium text-green-600' : 'text-gray-500'">
              {{ slot.status }}
            </span>
          </li>
        </ul>
        <div *ngIf="noSlotsAvailable" class="p-3 mb-3 text-center text-red-600 bg-red-100 rounded">
          Aucun cr√©neau n‚Äôest disponible pour cette journ√©e.
        </div>
      </div>

      <!-- COLONNE DROITE : Date, prix, paiement -->
      <div>

        <!-- S√©lecteur de date -->
        <div class="mb-4 rounded-lg border p-4">
          <label class="mb-2 block text-center font-medium text-gray-700 md:text-end">
            S√©lectionner une date
          </label>

          <!-- Date affich√©e proprement -->
          <div *ngIf="selectedDateCalendar" class="flex items-center justify-between">
            <span class="text-sm font-semibold md:text-lg">
              {{ selectedDateCalendar | date: "EEEE dd/MM/yyyy" }}
            </span>
            <button class="text-sm text-blue-500">‚úèÔ∏è</button>
          </div>

          <!-- Input date -->
          <div class="mt-2">
            <input
              type="date"
              [(ngModel)]="selectedDateCalendar"
              (change)="onDateChange()"
              class="w-full rounded border px-2 py-1"
            />
          </div>
        </div>

        <!-- Message information -->
        <div class="mb-4 rounded bg-blue-100 p-3 text-sm text-blue-800">
          En cas d‚Äôannulation jusqu‚Äô√† 2 heures avant, vous serez rembours√© du montant
          de la charge mais non des frais de r√©servation.
        </div>

        <!-- D√©tails du prix -->
        <div *ngIf="chargingStation" class="mb-4 rounded-lg border p-4">
          <h3 class="mb-2 font-semibold text-gray-700">D√©tails du prix</h3>

          <div class="mb-1 flex justify-between text-sm">
            <span *ngIf="bookingDurationHours > 0">
              {{ chargingStation.pricePerHour }}‚Ç¨ x {{ bookingDurationHours }} heures
            </span>
            <span>
              {{ chargingStation.pricePerHour * bookingDurationHours | number:"1.2-2" }} ‚Ç¨
            </span>
          </div>

          <div class="mb-1 flex justify-between text-sm">
            <span>Frais de r√©servation ({{ BOOKING_FEE_PERCENT }}%)</span>
            <span>
              {{
                chargingStation.pricePerHour * bookingDurationHours *
                (BOOKING_FEE_PERCENT / 100) | number:"1.2-2"
              }} ‚Ç¨
            </span>
          </div>

          <div class="flex justify-between font-bold text-gray-800">
            <span>Total √† r√©gler</span>
            <span>{{ totalPrice | number:"1.2-2" }} ‚Ç¨</span>
          </div>
        </div>

        <!-- Boutons paiement -->
        <div class="space-y-2">
          <button
            class="w-full rounded bg-yellow-400 py-2 font-bold text-gray-800 hover:bg-yellow-500"
            [disabled]="!selectedStartTime || !selectedEndTime"
            (click)="showPaymentFormHandler('paypal')"
          >
            Payer avec PayPal
          </button>

          <div class="text-center text-sm text-gray-500">ou</div>

          <button
            class="w-full rounded bg-green-500 py-2 font-bold text-white hover:bg-green-600"
            [disabled]="!selectedStartTime || !selectedEndTime"
            (click)="showPaymentFormHandler('card')"
          >
            Payer par carte
          </button>
        </div>

        <!-- FORMULAIRE DE PAIEMENT (APPARA√éT ICI) -->
        <div *ngIf="showPaymentForm" class="mt-4 rounded-lg border p-4">

          <!-- üîµ Formulaire PAYPAL -->
          <div *ngIf="paymentMethod === PaymentMethod.PAYPAL">
            <h3 class="mb-4 text-center text-xl font-bold text-blue-800">
              Connexion √† PayPal
            </h3>

            <form class="space-y-4">
              <input type="email" placeholder="Email" class="w-full rounded border px-3 py-2" />
              <input type="password" placeholder="Mot de passe" class="w-full rounded border px-3 py-2" />

              <button type="button" (click)="submitBooking()" class="w-full rounded bg-blue-800 py-2 font-bold text-white hover:bg-blue-900">
                Connexion
              </button>
            </form>
          </div>

          <!-- üü¢ Formulaire CARTE BANCAIRE -->
          <div *ngIf="paymentMethod === PaymentMethod.CB">
            <h3 class="mb-4 text-center text-xl font-bold text-gray-700">
              Information de la carte
            </h3>

            <form class="space-y-4">
              <input type="text" placeholder="Num√©ro de carte" class="w-full rounded border px-3 py-2" />

              <div class="flex gap-4">
                <input type="text" placeholder="MM / AA" class="w-1/2 rounded border px-3 py-2" />
                <input type="text" placeholder="CVC" class="w-1/2 rounded border px-3 py-2" />
              </div>

              <input type="text" placeholder="Nom du titulaire" class="w-full rounded border px-3 py-2" />
              <input type="text" placeholder="Adresse de facturation" class="w-full rounded border px-3 py-2" />

              <button type="button" (click)="submitBooking()" class="w-full rounded bg-green-600 py-2 font-bold text-white hover:bg-green-700">
                Payer
              </button>
            </form>
          </div>

        </div> 

      </div> 
    </div> 
    <!-- LIEN RETOUR -->
    <div class="mt-6">
      <a routerLink="/dashboard/rechargeVehicle" class="text-sm text-blue-500">
        ‚Üê Retour
      </a>
    </div>

  </div>
</section>
